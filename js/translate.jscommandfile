// DeepL ile otomatik Ã§eviri scripti - translations.js iÃ§in
// KullanÄ±m: node translate.js

const fs = require('fs');

// DeepL API anahtarÄ±nÄ±zÄ± buraya girin
const DEEPL_API_KEY = '130203a9-4adf-459e-9de4-ac69e1459c47:fx';
const DEEPL_API_URL = 'https://api-free.deepl.com/v2/translate'; // Ãœcretsiz plan iÃ§in
// Ãœcretli plan kullanÄ±yorsanÄ±z: 'https://api.deepl.com/v2/translate'

const translationsPath = './translations.js';
const outputPath = './translations_tr.js';
const checkpointPath = './translation_checkpoint.json';

// Checkpoint kaydet
function saveCheckpoint(translated) {
  fs.writeFileSync(checkpointPath, JSON.stringify(translated, null, 2), 'utf8');
}

// Checkpoint yÃ¼kle
function loadCheckpoint() {
  if (fs.existsSync(checkpointPath)) {
    return JSON.parse(fs.readFileSync(checkpointPath, 'utf8'));
  }
  return null;
}

async function translateText(text, targetLang = 'TR', retries = 3) {
  // BoÅŸ string ise Ã§evirme
  if (!text || text.trim() === '') {
    return '';
  }
  
  for (let attempt = 1; attempt <= retries; attempt++) {
    try {
      const response = await fetch(DEEPL_API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `DeepL-Auth-Key ${DEEPL_API_KEY}`
        },
        body: JSON.stringify({
          text: [text],
          target_lang: targetLang,
          source_lang: 'EN'
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        
        // Rate limit hatasÄ± ise daha uzun bekle
        if (response.status === 429) {
          console.log(`\nâš ï¸  Rate limit! ${attempt}/${retries} deneme - 10 saniye bekleniyor...`);
          await new Promise(resolve => setTimeout(resolve, 10000));
          continue;
        }
        
        throw new Error(`API hatasÄ± ${response.status}: ${JSON.stringify(errorData)}`);
      }

      const data = await response.json();
      return data.translations[0].text;
      
    } catch (error) {
      console.log(`\nâš ï¸  Hata (deneme ${attempt}/${retries}): ${error.message}`);
      
      if (attempt < retries) {
        const waitTime = attempt * 2000; // Her denemede daha uzun bekle
        console.log(`   ${waitTime/1000} saniye bekleyip tekrar denenecek...`);
        await new Promise(resolve => setTimeout(resolve, waitTime));
      } else {
        console.error(`\nâŒ Ã‡eviri baÅŸarÄ±sÄ±z ("${text.substring(0, 50)}..."): ${error.message}`);
        return text; // Son denemede de baÅŸarÄ±sÄ±z olursa orijinal metni dÃ¶ndÃ¼r
      }
    }
  }
  
  return text;
}

async function translateInBatches(entries, batchSize = 30) {
  const keys = Object.keys(entries);
  let completed = 0;
  
  // Checkpoint varsa yÃ¼kle
  let translated = loadCheckpoint();
  if (translated) {
    completed = Object.keys(translated).length;
    console.log(`ğŸ“¦ Checkpoint bulundu! ${completed} Ã§eviri yÃ¼klendi, kaldÄ±ÄŸÄ± yerden devam ediliyor...\n`);
  } else {
    translated = {};
  }
  
  for (let i = 0; i < keys.length; i += batchSize) {
    const batch = keys.slice(i, i + batchSize);
    
    console.log(`\nğŸ“¦ Batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(keys.length/batchSize)}: ${i + 1}-${Math.min(i + batchSize, keys.length)} / ${keys.length}`);
    
    for (const key of batch) {
      // Zaten Ã§evrilmiÅŸse atla
      if (translated[key] !== undefined) {
        continue;
      }
      
      const value = entries[key];
      
      if (value === '') {
        // BoÅŸ deÄŸer varsa KEY'i Ã§evir
        const translatedKey = await translateText(key);
        translated[key] = translatedKey;
      } else {
        // DeÄŸer doluysa VALUE'yu Ã§evir
        const translatedValue = await translateText(value);
        translated[key] = translatedValue;
      }
      
      completed++;
      
      // Ä°lerlemeyi gÃ¶ster
      process.stdout.write(`\r  âœ“ ${completed}/${keys.length} tamamlandÄ±`);
      
      // Her 10 Ã§eviride bir checkpoint kaydet
      if (completed % 10 === 0) {
        saveCheckpoint(translated);
      }
      
      // API rate limit iÃ§in bekleme (200ms - daha gÃ¼venli)
      await new Promise(resolve => setTimeout(resolve, 200));
    }
    
    // Her batch sonrasÄ± checkpoint kaydet ve bekle
    saveCheckpoint(translated);
    
    if (i + batchSize < keys.length) {
      console.log('\n  ğŸ’¾ Checkpoint kaydedildi');
      console.log('  â³ Sonraki batch iÃ§in 3 saniye bekleniyor...');
      await new Promise(resolve => setTimeout(resolve, 3000));
    }
  }
  
  console.log('\n');
  return translated;
}

async function main() {
  try {
    console.log('ğŸ“„ translations.js dosyasÄ± okunuyor...\n');
    
    // DosyayÄ± oku
    const fileContent = fs.readFileSync(translationsPath, 'utf8');
    
    // tr_translations objesini Ã§Ä±kar
    const match = fileContent.match(/const\s+tr_translations\s*=\s*({[\s\S]*});/);
    
    if (!match) {
      throw new Error('tr_translations objesi bulunamadÄ±');
    }
    
    // Objeyi parse et
    const translations = eval('(' + match[1] + ')');
    
    // Ä°statistikleri gÃ¶ster
    const emptyCount = Object.values(translations).filter(v => v === '').length;
    console.log(`ğŸ“Š Toplam ${Object.keys(translations).length} anahtar bulundu`);
    console.log(`ğŸ”¤ ${emptyCount} adet KEY Ã§evrilecek (boÅŸ olanlar)`);
    console.log(`ğŸ“ ${Object.keys(translations).length - emptyCount} adet VALUE Ã§evrilecek (dolu olanlar)\n`);
    console.log('ğŸš€ Ã‡eviri baÅŸlÄ±yor...\n');
    console.log('ğŸ’¡ Ä°pucu: Hata alÄ±rsanÄ±z scripti tekrar Ã§alÄ±ÅŸtÄ±rÄ±n, kaldÄ±ÄŸÄ± yerden devam eder.\n');
    
    // Ã‡eviriyi yap
    const turkishTranslations = await translateInBatches(translations);
    
    // Yeni dosya iÃ§eriÄŸini oluÅŸtur
    const outputContent = `const tr_translations = ${JSON.stringify(turkishTranslations, null, 4)};\n`;
    
    // DosyayÄ± kaydet
    fs.writeFileSync(outputPath, outputContent, 'utf8');
    
    // Checkpoint dosyasÄ±nÄ± sil
    if (fs.existsSync(checkpointPath)) {
      fs.unlinkSync(checkpointPath);
    }
    
    console.log('âœ… Ã‡eviri tamamlandÄ±!');
    console.log(`ğŸ“ SonuÃ§ dosyasÄ±: ${outputPath}\n`);
    
    // Ä°statistikleri gÃ¶ster
    const translatedCount = Object.values(turkishTranslations).filter(v => v !== '').length;
    console.log(`ğŸ“ˆ Ä°statistikler:`);
    console.log(`   â€¢ Toplam anahtar: ${Object.keys(turkishTranslations).length}`);
    console.log(`   â€¢ Ã‡evrilen: ${translatedCount}`);
    console.log(`   â€¢ BoÅŸ bÄ±rakÄ±lan: ${Object.keys(turkishTranslations).length - translatedCount}`);
    
  } catch (error) {
    console.error('\nâŒ Hata:', error.message);
    console.log('\nğŸ’¡ Checkpoint kaydedildi. Scripti tekrar Ã§alÄ±ÅŸtÄ±rarak kaldÄ±ÄŸÄ± yerden devam edebilirsiniz.');
    process.exit(1);
  }
}

main();